# Î∞∞Ìè¨ Í∞ÄÏù¥Îìú

**Î≤ÑÏ†Ñ**: 1.0
**ÏûëÏÑ±Ïùº**: 2025-10-14
**ÌôòÍ≤Ω**: Í∞úÎ∞ú ‚Üí Ïä§ÌÖåÏù¥Ïßï ‚Üí ÌîÑÎ°úÎçïÏÖò

---

## üìö Î™©Ï∞®

- [Î∞∞Ìè¨ Í∞úÏöî](#-Î∞∞Ìè¨-Í∞úÏöî)
- [ÌôòÍ≤Ω Íµ¨ÏÑ±](#-ÌôòÍ≤Ω-Íµ¨ÏÑ±)
- [Docker Î∞∞Ìè¨](#-docker-Î∞∞Ìè¨)
- [Kubernetes Î∞∞Ìè¨](#-kubernetes-Î∞∞Ìè¨)
- [CI/CD ÌååÏù¥ÌîÑÎùºÏù∏](#-cicd-ÌååÏù¥ÌîÑÎùºÏù∏)
- [Î™®ÎãàÌÑ∞ÎßÅ Î∞è Î°úÍπÖ](#-Î™®ÎãàÌÑ∞ÎßÅ-Î∞è-Î°úÍπÖ)
- [Î≥¥Ïïà ÏÑ§Ï†ï](#-Î≥¥Ïïà-ÏÑ§Ï†ï)
- [Î°§Î∞± Î∞è Î≥µÍµ¨](#-Î°§Î∞±-Î∞è-Î≥µÍµ¨)

---

## üéØ Î∞∞Ìè¨ Í∞úÏöî

### Î∞∞Ìè¨ Ï†ÑÎûµ

| ÌôòÍ≤Ω | Ïö©ÎèÑ | ÎèÑÎ©îÏù∏ (ÏòàÏãú) | ÏÉÅÌÉú |
|------|------|--------------|------|
| **Development** | Î°úÏª¨ Í∞úÎ∞ú | `localhost:8000` | ‚úÖ Íµ¨Ï∂ï ÏôÑÎ£å |
| **Staging** | ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω | `staging.holmesnyangz.com` | üîú ÏòàÏ†ï |
| **Production** | Ïã§ÏÑúÎπÑÏä§ | `api.holmesnyangz.com` | üîú ÏòàÏ†ï |

### ÏïÑÌÇ§ÌÖçÏ≤ò (ÌîÑÎ°úÎçïÏÖò)

```mermaid
flowchart LR
    Users([ÏÇ¨Ïö©Ïûê])

    subgraph CloudFlare["‚òÅÔ∏è CloudFlare"]
        CDN[CDN + DDoS Protection]
    end

    subgraph LoadBalancer["‚öñÔ∏è Load Balancer"]
        NGINX[NGINX]
    end

    subgraph Backend["üîß Backend Cluster"]
        API1[FastAPI Pod 1]
        API2[FastAPI Pod 2]
        API3[FastAPI Pod 3]
    end

    subgraph Database["üíæ Database"]
        PG[PostgreSQL Primary]
        PG_R[PostgreSQL Replica]
    end

    subgraph Cache["‚ö° Cache"]
        Redis[Redis Cluster]
    end

    subgraph Monitoring["üìä Monitoring"]
        Prometheus[Prometheus]
        Grafana[Grafana]
        Sentry[Sentry]
    end

    Users --> CDN
    CDN --> NGINX
    NGINX --> API1
    NGINX --> API2
    NGINX --> API3

    API1 --> PG
    API2 --> PG
    API3 --> PG

    PG --> PG_R

    API1 --> Redis
    API2 --> Redis
    API3 --> Redis

    API1 -.-> Prometheus
    API2 -.-> Prometheus
    API3 -.-> Prometheus

    Prometheus --> Grafana
    API1 -.-> Sentry
```

---

## ‚öôÔ∏è ÌôòÍ≤Ω Íµ¨ÏÑ±

### 1. ÌôòÍ≤Ω Î≥ÄÏàò (.env)

#### Development

```bash
# .env.development
NODE_ENV=development
LOG_LEVEL=DEBUG

# OpenAI
OPENAI_API_KEY=sk-...

# PostgreSQL (Local)
DATABASE_URL=postgresql://postgres:root1234@localhost:5432/real_estate

# Redis (Optional)
# REDIS_URL=redis://localhost:6379/0
```

#### Staging

```bash
# .env.staging
NODE_ENV=staging
LOG_LEVEL=INFO

# OpenAI
OPENAI_API_KEY=sk-...

# PostgreSQL (Cloud)
DATABASE_URL=postgresql://user:password@staging-db.example.com:5432/real_estate

# Redis
REDIS_URL=redis://staging-redis.example.com:6379/0

# Monitoring
SENTRY_DSN=https://xxx@sentry.io/yyy
```

#### Production

```bash
# .env.production
NODE_ENV=production
LOG_LEVEL=WARNING

# OpenAI
OPENAI_API_KEY=sk-...

# PostgreSQL (HA Cluster)
DATABASE_URL=postgresql://user:password@prod-db.example.com:5432/real_estate

# Redis (Cluster)
REDIS_URL=redis://prod-redis.example.com:6379/0

# Monitoring
SENTRY_DSN=https://xxx@sentry.io/yyy
PROMETHEUS_MULTIPROC_DIR=/tmp

# Security
CORS_ORIGINS=["https://holmesnyangz.com"]
ALLOWED_HOSTS=["api.holmesnyangz.com"]
```

---

## üê≥ Docker Î∞∞Ìè¨

### 1. Dockerfile (Backend)

```dockerfile
# backend/Dockerfile
FROM python:3.11-slim

# ÏûëÏóÖ ÎîîÎ†âÌÜ†Î¶¨
WORKDIR /app

# ÏãúÏä§ÌÖú ÏùòÏ°¥ÏÑ±
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Python ÏùòÏ°¥ÏÑ±
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏΩîÎìú
COPY . .

# ÎπÑÎ£®Ìä∏ ÏÇ¨Ïö©Ïûê
RUN useradd -m -u 1000 appuser && \
    chown -R appuser:appuser /app
USER appuser

# Ìó¨Ïä§Ï≤¥ÌÅ¨
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD python -c "import requests; requests.get('http://localhost:8000/health')"

# Ïã§Ìñâ
EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]
```

### 2. Docker Compose (Ï†ÑÏ≤¥ Ïä§ÌÉù)

```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQL
  postgres:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: real_estate
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis (Optional)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/real_estate
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      REDIS_URL: redis://redis:6379/0
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    restart: unless-stopped

  # Frontend (Optional)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8000
      NEXT_PUBLIC_WS_URL: ws://localhost:8000
    ports:
      - "3000:3000"
    depends_on:
      - backend
    restart: unless-stopped

  # NGINX (Reverse Proxy)
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
      - frontend
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
```

### 3. ÎπåÎìú Î∞è Ïã§Ìñâ

```bash
# Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
docker-compose build

# Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë (detached mode)
docker-compose up -d

# Î°úÍ∑∏ ÌôïÏù∏
docker-compose logs -f backend

# Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ
docker-compose down

# Î≥ºÎ•® Ìè¨Ìï® ÏÇ≠Ï†ú (Ï£ºÏùò!)
docker-compose down -v
```

### 4. Docker Hub Î∞∞Ìè¨

```bash
# Ïù¥ÎØ∏ÏßÄ ÌÉúÍπÖ
docker tag holmesnyangz-backend:latest holmesnyangz/backend:1.0.0
docker tag holmesnyangz-backend:latest holmesnyangz/backend:latest

# Docker Hub Î°úÍ∑∏Ïù∏
docker login

# Ïù¥ÎØ∏ÏßÄ Ìë∏Ïãú
docker push holmesnyangz/backend:1.0.0
docker push holmesnyangz/backend:latest
```

---

## ‚ò∏Ô∏è Kubernetes Î∞∞Ìè¨

### 1. Namespace

```yaml
# k8s/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: holmesnyangz
```

### 2. ConfigMap (ÌôòÍ≤Ω Î≥ÄÏàò)

```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-config
  namespace: holmesnyangz
data:
  LOG_LEVEL: "INFO"
  POSTGRES_HOST: "postgres-service"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "real_estate"
  REDIS_URL: "redis://redis-service:6379/0"
```

### 3. Secret (ÎØºÍ∞ê Ï†ïÎ≥¥)

```yaml
# k8s/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: backend-secret
  namespace: holmesnyangz
type: Opaque
data:
  OPENAI_API_KEY: <base64-encoded>
  POSTGRES_PASSWORD: <base64-encoded>
```

```bash
# Secret ÏÉùÏÑ± (CLI)
kubectl create secret generic backend-secret \
  --from-literal=OPENAI_API_KEY=sk-... \
  --from-literal=POSTGRES_PASSWORD=root1234 \
  -n holmesnyangz
```

### 4. Deployment (Backend)

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: holmesnyangz
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: holmesnyangz/backend:1.0.0
        ports:
        - containerPort: 8000
        env:
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: LOG_LEVEL
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: backend-secret
              key: OPENAI_API_KEY
        - name: DATABASE_URL
          value: "postgresql://postgres:$(POSTGRES_PASSWORD)@$(POSTGRES_HOST):$(POSTGRES_PORT)/$(POSTGRES_DB)"
        envFrom:
        - configMapRef:
            name: backend-config
        - secretRef:
            name: backend-secret
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
```

### 5. Service (LoadBalancer)

```yaml
# k8s/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: holmesnyangz
spec:
  type: LoadBalancer
  selector:
    app: backend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8000
```

### 6. Ingress (NGINX)

```yaml
# k8s/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: backend-ingress
  namespace: holmesnyangz
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - api.holmesnyangz.com
    secretName: backend-tls
  rules:
  - host: api.holmesnyangz.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 80
```

### 7. HPA (Horizontal Pod Autoscaler)

```yaml
# k8s/hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: backend-hpa
  namespace: holmesnyangz
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: backend
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### 8. Î∞∞Ìè¨ Ïã§Ìñâ

```bash
# Namespace ÏÉùÏÑ±
kubectl apply -f k8s/namespace.yaml

# ConfigMap & Secret
kubectl apply -f k8s/configmap.yaml
kubectl apply -f k8s/secret.yaml

# Deployment & Service
kubectl apply -f k8s/deployment.yaml
kubectl apply -f k8s/service.yaml

# Ingress
kubectl apply -f k8s/ingress.yaml

# HPA
kubectl apply -f k8s/hpa.yaml

# ÏÉÅÌÉú ÌôïÏù∏
kubectl get all -n holmesnyangz
kubectl get pods -n holmesnyangz -w

# Î°úÍ∑∏ ÌôïÏù∏
kubectl logs -f deployment/backend -n holmesnyangz
```

---

## üîÑ CI/CD ÌååÏù¥ÌîÑÎùºÏù∏

### GitHub Actions (ÏòàÏãú)

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        push: true
        tags: |
          holmesnyangz/backend:latest
          holmesnyangz/backend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Deploy to Kubernetes
      uses: azure/k8s-deploy@v4
      with:
        manifests: |
          k8s/deployment.yaml
          k8s/service.yaml
        images: |
          holmesnyangz/backend:${{ github.sha }}
        namespace: holmesnyangz

    - name: Verify deployment
      run: |
        kubectl rollout status deployment/backend -n holmesnyangz
```

---

## üìä Î™®ÎãàÌÑ∞ÎßÅ Î∞è Î°úÍπÖ

### 1. Prometheus + Grafana

```yaml
# k8s/monitoring/prometheus.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: holmesnyangz
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
      - job_name: 'backend'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - holmesnyangz
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: backend
```

### 2. Sentry (ÏóêÎü¨ Ï∂îÏ†Å)

```python
# backend/app/main.py
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

sentry_sdk.init(
    dsn=os.getenv("SENTRY_DSN"),
    integrations=[FastApiIntegration()],
    traces_sample_rate=0.1,
    environment=os.getenv("NODE_ENV", "development")
)
```

### 3. Î°úÍπÖ (ELK Stack)

```yaml
# k8s/logging/filebeat.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
  namespace: holmesnyangz
data:
  filebeat.yml: |
    filebeat.inputs:
    - type: container
      paths:
        - /var/log/containers/*backend*.log
    output.elasticsearch:
      hosts: ["elasticsearch:9200"]
```

---

## üîí Î≥¥Ïïà ÏÑ§Ï†ï

### 1. HTTPS (Let's Encrypt)

```bash
# cert-manager ÏÑ§Ïπò
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml

# ClusterIssuer ÏÉùÏÑ±
kubectl apply -f - <<EOF
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@holmesnyangz.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
EOF
```

### 2. Network Policies

```yaml
# k8s/security/network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-netpol
  namespace: holmesnyangz
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: nginx
    ports:
    - protocol: TCP
      port: 8000
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
```

---

## üîô Î°§Î∞± Î∞è Î≥µÍµ¨

### 1. Kubernetes Î°§Î∞±

```bash
# Î°§ÏïÑÏõÉ ÌûàÏä§ÌÜ†Î¶¨ ÌôïÏù∏
kubectl rollout history deployment/backend -n holmesnyangz

# Ïù¥Ï†Ñ Î≤ÑÏ†ÑÏúºÎ°ú Î°§Î∞±
kubectl rollout undo deployment/backend -n holmesnyangz

# ÌäπÏ†ï Î¶¨ÎπÑÏ†ÑÏúºÎ°ú Î°§Î∞±
kubectl rollout undo deployment/backend --to-revision=2 -n holmesnyangz

# Î°§ÏïÑÏõÉ ÏÉÅÌÉú ÌôïÏù∏
kubectl rollout status deployment/backend -n holmesnyangz
```

### 2. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Î≥µÍµ¨

```bash
# Î∞±ÏóÖÏóêÏÑú Î≥µÍµ¨
psql -U postgres -d real_estate < backup_20251014.sql

# PITR (Point-in-Time Recovery) - PostgreSQL
# 1. WAL ÏïÑÏπ¥Ïù¥Î∏å Î≥µÏÇ¨
# 2. recovery.conf ÏÑ§Ï†ï
# 3. PostgreSQL Ïû¨ÏãúÏûë
```

---

## üìã Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏

### Î∞∞Ìè¨ Ï†Ñ

- [ ] `.env.production` ÌååÏùº ÌôïÏù∏
- [ ] Secret ÏÉùÏÑ± Î∞è Í≤ÄÏ¶ù
- [ ] Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Î∞±ÏóÖ
- [ ] Î°§Î∞± Í≥ÑÌöç ÏàòÎ¶Ω
- [ ] Î™®ÎãàÌÑ∞ÎßÅ ÎèÑÍµ¨ Ï§ÄÎπÑ

### Î∞∞Ìè¨ Ï§ë

- [ ] Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
- [ ] Ïù¥ÎØ∏ÏßÄ Ìë∏Ïãú (Docker Hub)
- [ ] Kubernetes Î∞∞Ìè¨
- [ ] Health Check ÌôïÏù∏
- [ ] Smoke Test Ïã§Ìñâ

### Î∞∞Ìè¨ ÌõÑ

- [ ] Î°úÍ∑∏ ÌôïÏù∏ (ÏóêÎü¨ ÏóÜÏùå)
- [ ] Î™®ÎãàÌÑ∞ÎßÅ ÎåÄÏãúÎ≥¥Îìú ÌôïÏù∏
- [ ] API ÏùëÎãµ ÏãúÍ∞Ñ ÌôïÏù∏
- [ ] ÏÇ¨Ïö©Ïûê ÌîºÎìúÎ∞± ÏàòÏßë
- [ ] Î¨∏ÏÑú ÏóÖÎç∞Ïù¥Ìä∏

---

**ÏÉùÏÑ±Ïùº**: 2025-10-14
**Î≤ÑÏ†Ñ**: 1.0
**ÏÉÅÌÉú**: üìã Î∞∞Ìè¨ Ï§ÄÎπÑ Í∞ÄÏù¥Îìú
